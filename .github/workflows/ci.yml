name: CI Pipeline

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
  schedule:
    - cron: '0 18 * * *'  # æ¯æ—¥ 03:00 JST ç›¸å½“

permissions:
  contents: read
  pull-requests: read

env:
  TURBO_TELEMETRY_DISABLED: "1"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      client: ${{ steps.filter.outputs.client }}
      api-service: ${{ steps.filter.outputs.api-service }}
      packagesAll: ${{ steps.filter.outputs.packagesAll }}
      deps: ${{ steps.filter.outputs.deps }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            client:
              - 'apps/client/**'
              - 'packages/ui/**'
              - 'packages/api-client/**'
              - 'packages/result/**'
              - 'packages/typescript-config/**'
              - 'packages/tailwind-config/**'
            api-service:
              - 'apps/api-service/**'
              - 'packages/database/**'
              - 'packages/server-kit/**'
              - 'packages/result/**'
            packagesAll:
              - 'packages/**'
            deps:
              - '**/package.json'
              - 'bun.lock'

  ci:
    name: CI Pipeline
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 20
    if: needs.changes.outputs.client == 'true' || needs.changes.outputs.api-service == 'true' || needs.changes.outputs.packagesAll == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.22'

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Restore Bun cache
        id: bun-cache-ci
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.bun
            ~/.cache/bun
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Restore Turbo cache
        id: turbo-cache-ci
        uses: actions/cache/restore@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.ref }}-${{ hashFiles('**/turbo.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-turbo-${{ github.ref }}-
            ${{ runner.os }}-turbo-refs/heads/main-
            ${{ runner.os }}-turbo-

      - name: Restore Prisma cache
        id: prisma-cache-ci
        uses: actions/cache/restore@v4
        with:
          path: |
            packages/database/node_modules/.prisma
            packages/database/node_modules/@prisma
          key: ${{ runner.os }}-prisma-${{ hashFiles('packages/database/prisma/schema.prisma', 'packages/database/prisma/**/*.prisma') }}
          restore-keys: |
            ${{ runner.os }}-prisma-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Save Bun cache
        if: steps.bun-cache-ci.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.bun
            ~/.cache/bun
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}

      - name: Generate Prisma Client
        if: steps.prisma-cache-ci.outputs.cache-hit != 'true'
        run: |
          cd packages/database
          bun run db:generate
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: Save Prisma cache
        if: steps.prisma-cache-ci.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            packages/database/node_modules/.prisma
            packages/database/node_modules/@prisma
          key: ${{ runner.os }}-prisma-${{ hashFiles('packages/database/prisma/schema.prisma', 'packages/database/prisma/**/*.prisma') }}

      - name: Run CI Quality Checks
        env:
          CI: true
        run: |
          set -euo pipefail
          FILTERS=""
          if [[ "${{ needs.changes.outputs.client }}" == "true" ]]; then
            FILTERS="$FILTERS --filter=client"
          fi
          if [[ "${{ needs.changes.outputs.api-service }}" == "true" ]]; then
            FILTERS="$FILTERS --filter=api-service"
          fi

          if [[ -z "$FILTERS" ]]; then
            echo "No specific app changes; running lint/typecheck across repo"
            bunx turbo run lint typecheck --concurrency=4 --cache-dir=.turbo
          else
            echo "Running lint/typecheck for changed packages: $FILTERS"
            bunx turbo run lint typecheck --concurrency=4 --cache-dir=.turbo $FILTERS
          fi

      - name: Save Turbo cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.ref }}-${{ hashFiles('**/turbo.json', '**/package.json') }}

      - name: Architecture & FSD Checks
        run: |
          echo "ğŸ—ï¸ Running Architecture & FSD Checks in main pipeline..."
          bash scripts/architecture-check.sh

      - name: Build changed packages for PR
        if: github.event_name == 'pull_request'
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
        run: |
          set -euo pipefail
          FILTERS=""
          if [[ "${{ needs.changes.outputs.client }}" == "true" ]]; then
            FILTERS="$FILTERS --filter=client"
          fi
          if [[ "${{ needs.changes.outputs.api-service }}" == "true" ]]; then
            FILTERS="$FILTERS --filter=api-service"
          fi
          if [[ -z "$FILTERS" ]]; then
            echo "No changes detected, skip build"
          else
            echo "Building changed packages: $FILTERS"
            bunx turbo run build --concurrency=4 --cache-dir=.turbo $FILTERS
          fi

      - name: Build all packages for main branch
        if: github.ref == 'refs/heads/main'
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
        run: bunx turbo run build --concurrency=4 --cache-dir=.turbo

      - name: Save Turbo cache after build
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.ref }}-${{ hashFiles('**/turbo.json', '**/package.json') }}


  bun-audit-pr:
    name: bun audit (Report)
    runs-on: ubuntu-latest
    needs: changes
    # ä¾å­˜å¤‰æ›´æ™‚ or ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚ã®ã¿ï¼ˆPR/Pushå…±é€šï¼‰
    if: github.event_name == 'schedule' || needs.changes.outputs.deps == 'true'
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.22'
      - name: Restore Bun cache
        id: bun-cache-audit
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.bun
            ~/.cache/bun
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Save Bun cache
        if: steps.bun-cache-audit.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.bun
            ~/.cache/bun
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
      - name: Run bun audit
        id: audit
        run: |
          set +e
          bun audit > audit-output.txt 2>&1
          STATUS=$?
          set -e
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          {
            echo "## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»çµæœ (bun audit)";
            echo;
            if [ "$STATUS" -eq 0 ]; then
              echo "### âœ… çµæœ: å•é¡Œãªã—";
              echo "ä¾å­˜é–¢ä¿‚ã«æ—¢çŸ¥ã®è„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚";
            else
              echo "### âš ï¸ çµæœ: è„†å¼±æ€§ã‚ã‚Š";
              echo;
              echo "<details>";
              echo "<summary>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ bun audit ã®è©³ç´°å‡ºåŠ›ã‚’è¡¨ç¤º</summary>";
              echo;
              echo '```';
              head -1000 audit-output.txt || true;
              echo '```';
              echo "</details>";
            fi
          } > audit-report.md
      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bun-audit-report
          path: |
            audit-output.txt
            audit-report.md
      - name: Post bun audit result as PR comment (sticky)
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('audit-report.md', 'utf8');
            const marker = '## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»çµæœ (bun audit)';
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100,
            });
            const botComment = comments.find(c => c.user?.login === 'github-actions[bot]' && c.body?.includes(marker));
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

